# Chatworkログ取得自動化 全体設計

---

## ゴール

**毎日深夜1時に、前日の自分に関係するChatwork活動をすべて自動で要約し、Obsidianに保存する**

---

## 取得対象

- **自分が参加している全ルーム**（更新があったもの）
- **自分宛てメンション**（To:674453）
- **自分が送信したメッセージ**（account_id: 674453）

---

## 処理フロー

```
毎日深夜1時
    ↓
参加中の全ルーム一覧を取得
    ↓
更新があったルームのみ抽出
    ↓
各ルームからメッセージ取得
    ↓
前日分のみ抽出
    ↓
自分宛てメンション・自分の発言を分離
    ↓
ルームごとにClaude APIで要約
    ↓
Obsidianデイリーノートに追記
    ↓
Google Sheetsに生データ保存（アーカイブ用）
```

---

## 出力イメージ

### Obsidianデイリーノート（2026-01-12.md）

```markdown
## Chatwork要約

### 🔔 自分宛てメンション（3件）
- [プロジェクトA] 田中さん: 明日の会議資料確認お願いします
- [営業部] 鈴木さん: 見積もりの件、返信ください
- [開発部] 山田さん: PRレビューお願いします

### 💬 自分の発言（5件）
- [プロジェクトA] 了解です、明日までに確認します
- [営業部] 見積もり送付しました
- [開発部] PR確認完了、LGTM
- [開発部] デプロイ完了しました
- [経理部] 経費精算提出しました

### 📝 ルーム別サマリー
- **プロジェクトA**: 進捗報告3件、タスク割り振りの議論
- **営業部**: 新規案件2件の共有、来週の訪問予定調整
- **開発部**: バグ修正完了報告、次スプリントの計画
- **経理部**: 経費精算の締切リマインド
...
```

---

## データ保存先

| データ | 保存先 | 目的 |
|--------|--------|------|
| 要約 | Obsidianデイリーノート | 毎日の確認用 |
| 生データ | Google Sheets | 検索・分析用アーカイブ |

---

## 実装フェーズ

### Phase 1: 単一ルーム完成（現在ここ）
- [x] Chatwork API接続
- [x] 前日分フィルタ
- [ ] Obsidianデイリーノート追記
- [ ] 動作確認

### Phase 2: 要約機能追加
- [ ] Claude API接続
- [ ] ルーム単位で要約生成
- [ ] 要約テンプレート調整

### Phase 3: 自分関連メッセージ抽出
- [ ] 自分宛てメンション（To:674453）を分離
- [ ] 自分の発言（account_id: 674453）を分離
- [ ] 専用セクション作成

### Phase 4: 全ルーム対応
- [ ] 参加ルーム一覧取得（GET /rooms）
- [ ] 更新ありルームのフィルタ
- [ ] ループ処理実装
- [ ] エラーハンドリング

### Phase 5: 本番運用
- [ ] API制限対応（レート制限）
- [ ] Google Sheets保存
- [ ] 本番運用開始

---

## 技術構成

| 役割 | ツール |
|------|--------|
| ワークフロー実行 | n8n（クラウド版） |
| メッセージ取得 | Chatwork API |
| 要約生成 | Claude API |
| 日次レポート | Obsidian（Local REST API + ngrok） |
| データアーカイブ | Google Sheets |
| バージョン管理 | GitHub |

---

## Chatwork API エンドポイント

| 目的 | エンドポイント |
|------|----------------|
| 参加ルーム一覧 | GET /rooms |
| メッセージ取得 | GET /rooms/{room_id}/messages?force=1 |

### ルーム一覧レスポンス例
```json
{
  "room_id": 123,
  "name": "プロジェクトA",
  "last_update_time": 1768064684
}
```
→ `last_update_time` で前日更新ありを判定

---

## 制約・考慮事項

- **Chatwork API**: 1ルームあたり直近100件まで
- **Claude API**: トークン制限あり（要約で圧縮）
- **Obsidian**: ngrokトンネル経由（URLは固定ではない）
- **ルーム数**: 可変（参加状況により増減）
- **API制限**: ルーム数が多い場合は実行時間とレート制限に注意

---

## ワークフロー構成図

```
┌─────────────────┐
│ Schedule        │
│ 毎日深夜1時     │
└────────┬────────┘
         ↓
┌─────────────────┐
│ HTTP Request    │
│ GET /rooms      │
│ 参加ルーム一覧  │
└────────┬────────┘
         ↓
┌─────────────────┐
│ Filter          │
│ 前日更新あり    │
└────────┬────────┘
         ↓
┌─────────────────┐
│ Loop            │
│ 更新ルーム分    │←─────────────────┐
└────────┬────────┘                  │
         ↓                           │
┌─────────────────┐                  │
│ HTTP Request    │                  │
│ メッセージ取得  │                  │
└────────┬────────┘                  │
         ↓                           │
┌─────────────────┐                  │
│ Code            │                  │
│ 日付判定追加    │                  │
└────────┬────────┘                  │
         ↓                           │
┌─────────────────┐                  │
│ Filter          │                  │
│ 前日分のみ      │                  │
└────────┬────────┘                  │
         ↓                           │
┌─────────────────┐                  │
│ Split           │                  │
│ メンション分離  │                  │
│ 自分発言分離    │                  │
└────────┬────────┘                  │
         ↓                           │
┌─────────────────┐                  │
│ Claude API      │                  │
│ 要約生成        │                  │
└────────┬────────┘                  │
         ↓                           │
         └───────────────────────────┘
         ↓（全ルーム完了後）
┌─────────────────┐
│ Merge           │
│ 要約を統合      │
└────────┬────────┘
         ↓
┌─────────────────┐     ┌─────────────────┐
│ Obsidian API    │     │ Google Sheets   │
│ デイリーノート  │     │ 生データ保存    │
└─────────────────┘     └─────────────────┘
```

---

## 抽出ロジック

### 自分宛てメンション
- `body` に `[To:674453]` を含む

### 自分の発言
- `account.account_id` が `674453`

---

## 関連リンク

- **n8nワークフロー**: https://michi-gaeru.app.n8n.cloud/workflow/xtucgPWpcsbheP7S
- **GitHub**: https://github.com/kijins-dev/obsidian_summary_chatwork
- **Obsidian開発記録**: 02_プロジェクト/Chatworkログ取得自動化/

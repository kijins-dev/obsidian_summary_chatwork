# Chatwork日次ログ取得ワークフロー 開発記録

## 基本情報

- **ワークフローID**: xtucgPWpcsbheP7S
- **ワークフロー名**: Chatwork_毎日1時_前日ログ取得
- **n8n URL**: https://michi-gaeru.app.n8n.cloud/workflow/xtucgPWpcsbheP7S
- **対象Room ID**: 6852214（マイチャット）

---

## 2026-01-12 開発ログ

### 完了した作業

1. **基本ワークフロー構築**
   - Schedule Trigger: 毎日深夜1時（JST）実行
   - HTTP Request: Chatwork API でメッセージ取得
   - Filter: 前日分のみ抽出

2. **解決した問題**
   - 空レスポンスエラー → `responseFormat: "json"` 設定
   - 空配列問題 → URL末尾に `?force=1` 追加（直近100件取得）
   - Schedule Trigger設定 → `triggerAtHour: 1` で毎日1時固定

### 現在の問題: フィルタが機能しない

#### 症状
- HTTP Request: 100件取得（正常）
- Filter後: Kept=0件、Discarded=100件
- 1/11のデータ（`send_time: 1768064684`）が存在するのにフィルタで除外される

#### 原因調査中

計算式がn8nサンドボックス環境で正しく評価されていない可能性：

```javascript
// 前日の00:00:00 (JST)
{{ Math.floor(new Date(new Date().toLocaleString('en-US', {timeZone: 'Asia/Tokyo'})).setHours(0,0,0,0) / 1000) - 86400 }}

// 当日の00:00:00 (JST)
{{ Math.floor(new Date(new Date().toLocaleString('en-US', {timeZone: 'Asia/Tokyo'})).setHours(0,0,0,0) / 1000) }}
```

#### 実際のデータ
| メッセージ | send_time | 日時（JST） |
|-----------|-----------|-------------|
| 1/11 02:04 | 1768064684 | 2026-01-11 02:04 |
| 1/12 11:25 | 1768184731 | 2026-01-12 11:25 |

#### 問題点
計算式が2025年1月の値を返している可能性。
期待値：`1736521200`〜`1736607600`（2025年1月）
実際のデータ：`1768064684`（2026年1月）

**→ 年がずれている！計算式のDateオブジェクトがおかしい**

#### 次のステップ

1. 固定値でフィルタテスト
   - 条件1: `send_time >= 1768003200` (2026-01-11 00:00:00 JST)
   - 条件2: `send_time < 1768089600` (2026-01-12 00:00:00 JST)

2. 動作確認後、動的計算式を修正

---

## n8n 注意事項

### 必須ルール
- JSON欄では先頭の「=」は不要。`{{ }}`のみで動作
- コピペは特殊文字混入リスクあり。動かなければ手打ち
- Body Content Type切り替えは内部状態を壊す可能性あり
- 動いている設定は安易に触らない
- 変更は1箇所ずつ、動作確認しながら進める

### Chatwork API
- `?force=1`: 未読に関係なく直近100件取得
- `send_time`: UNIXタイムスタンプ（秒単位）

### タイムスタンプ変換メモ
```
2026-01-11 00:00:00 JST = 1768003200
2026-01-12 00:00:00 JST = 1768089600
2025-01-11 00:00:00 JST = 1736521200
2025-01-12 00:00:00 JST = 1736607600
```
